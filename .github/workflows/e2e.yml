name: Playwright E2E Tests

on: [push]

jobs:
  e2e:
    runs-on: ubuntu-latest

    steps:
      # 📦 Checkout Playwright tests repo (current repo)
      - name: Checkout Playwright tests
        uses: actions/checkout@v3

      # 📁 Checkout Angular app from separate public repo
      - name: Checkout Angular app
        uses: actions/checkout@v3
        with:
          repository: Abhijit5815/demoAppAngular
          path: angular-app
          token: ${{ secrets.GITHUB_TOKEN }}

      # 🔧 Clean install with legacy peer deps to handle known conflicts
      - name: Install Angular dependencies (clean install)
        working-directory: angular-app
        run: npm ci --legacy-peer-deps

      # 🚀 Start Angular stub app
      - name: Start Angular app
        working-directory: angular-app
        run: npm start &

      # ⏳ Wait for app to be responsive on localhost:4200
      - name: Wait for Angular app to be ready
        run: |
          for i in {1..5}; do
            curl -s http://localhost:4200 > /dev/null && echo "Angular app is ready" && break
            echo "Waiting for Angular app (attempt $i)..."
            sleep 5
          done

      # 🧪 Install Playwright and run tests
      - name: Install Playwright dependencies
        run: npm ci

      - name: Run Playwright tests
        run: npx playwright test
